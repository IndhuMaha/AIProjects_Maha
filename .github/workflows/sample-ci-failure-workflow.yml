name: CI Build and Test with n8n Failure Alert

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm install

      - name: Run Unit Tests
        run: |
          echo "Running unit tests..."
          echo "Error: Test suite failed - cannot read property 'length' of undefined"
          exit 1

      # âœ… Notify n8n if tests fail
      - name: Send failure alert to n8n
        if: failure()
        run: |
          # Replace this with your actual n8n webhook URL
          N8N_WEBHOOK_URL="http://localhost:5678/webhook/ci-build-webhook"

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"status\": \"failed\",
              \"repository\": \"${{ github.repository }}\",
              \"branch\": \"${{ github.ref_name }}\",
              \"commit\": \"${{ github.sha }}\",
              \"actor\": \"${{ github.actor }}\",
              \"run_url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"message\": \"Unit tests failed due to TypeError: Cannot read property 'length' of undefined.\"
            }" \
            $N8N_WEBHOOK_URL

